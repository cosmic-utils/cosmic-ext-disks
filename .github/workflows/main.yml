name: Main

on:
  push:
    tags: ["v*"]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup update
      - uses: Swatinem/rust-cache@v2
      - name: install system deps
        run: sudo apt install libxkbcommon-dev libbtrfsutil-dev
      - name: Run tests
        run: cargo test --workspace --all-features --locked
      - name: Run clippy
        run: cargo clippy --workspace --all-features --locked
      - name: Run rustfmt
        run: cargo fmt --all --check --verbose

  publish:
    name: Build and Publish
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: rustup update
      - uses: Swatinem/rust-cache@v2
      - name: install system deps
        run: sudo apt install libxkbcommon-dev libbtrfsutil-dev

      - name: Extract version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Release version: $VERSION"

      - name: Verify versions match tag
        run: |
          set -euo pipefail
          UI_VERSION=$(grep -E '^version\s*=\s*"' storage-ui/Cargo.toml | head -n1 | cut -d'"' -f2)
          DBUS_VERSION=$(grep -E '^version\s*=\s*"' storage-dbus/Cargo.toml | head -n1 | cut -d'"' -f2)
          ROOT_DEP_VERSION=$(grep -E '^storage-dbus\s*=\s*\{.*version\s*=\s*"' Cargo.toml | head -n1 | sed -E 's/.*version\s*=\s*"([^"]+)".*/\1/')

          echo "storage-ui version: $UI_VERSION"
          echo "storage-dbus version: $DBUS_VERSION"
          echo "root dep version: $ROOT_DEP_VERSION"

          if [ "$UI_VERSION" != "$VERSION" ]; then
            echo "storage-ui/Cargo.toml version ($UI_VERSION) does not match tag version ($VERSION)" >&2
            exit 1
          fi

          if [ "$DBUS_VERSION" != "$VERSION" ]; then
            echo "storage-dbus/Cargo.toml version ($DBUS_VERSION) does not match tag version ($VERSION)" >&2
            exit 1
          fi

          if [ "$ROOT_DEP_VERSION" != "$VERSION" ]; then
            echo "Cargo.toml workspace dep version ($ROOT_DEP_VERSION) does not match tag version ($VERSION)" >&2
            exit 1
          fi

      - name: Verify clean tree
        run: |
          git status --porcelain
          test -z "$(git status --porcelain)"

      - name: Build
        run: cargo build --workspace --release --locked

      - name: Publish cosmic-ext-storage-dbus
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd storage-dbus
          cargo publish --locked

      - name: Wait for index update
        run: sleep 30

      - name: Publish cosmic-ext-storage
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd storage-ui
          cargo publish --locked

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
