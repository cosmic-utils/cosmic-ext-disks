name: Update Version

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  bump:
    name: Bump version, commit, tag
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: rustup update
      - uses: Swatinem/rust-cache@v2

      - name: install system deps
        run: sudo apt install libxkbcommon-dev

      - name: Get Next Version
        id: semver
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)"
          version_format: "${major}.${minor}.${patch}"
          version_from_branch: false

      - name: Export VERSION
        run: |
          set -euo pipefail
          VERSION="${{ steps.semver.outputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="0.0.1"
          fi
          echo "Calculated version: $VERSION"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Check for existing version PR
        id: pr_check
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branchPrefix = 'chore/release-v';

            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            const exists = pulls.some(pr => pr.head && typeof pr.head.ref === 'string' && pr.head.ref.startsWith(branchPrefix));
            core.setOutput('exists', exists ? 'true' : 'false');
            core.info(exists
              ? `Found existing open release PR (branch starts with ${branchPrefix}); skipping.`
              : `No open release PR found (branch starts with ${branchPrefix}); continuing.`);

      - name: Skip (existing version PR)
        if: steps.pr_check.outputs.exists == 'true'
        run: echo "Version PR already exists for v$VERSION; skipping remaining steps."

      - name: Set versions in Cargo.toml
        if: steps.pr_check.outputs.exists != 'true'
        run: |
          set -euo pipefail
          VERSION="$VERSION"
          sed -i 's/^version = ".*"/version = "'$VERSION'"/' disks-dbus/Cargo.toml
          sed -i 's/^version = ".*"/version = "'$VERSION'"/' disks-ui/Cargo.toml

          # Keep the workspace dependency version in sync so cargo can publish without mutating files.
          sed -i 's|disks-dbus = { package = "cosmic-ext-disks-dbus", path = "disks-dbus", version = ".*" }|disks-dbus = { package = "cosmic-ext-disks-dbus", path = "disks-dbus", version = "'$VERSION'" }|' Cargo.toml

      - name: Run fmt
        if: steps.pr_check.outputs.exists != 'true'
        run: cargo fmt --all

      - name: Run tests
        if: steps.pr_check.outputs.exists != 'true'
        run: cargo test --workspace --all-features

      - name: Run clippy
        if: steps.pr_check.outputs.exists != 'true'
        run: cargo clippy --workspace --all-features

      - name: Commit version bump
        if: steps.pr_check.outputs.exists != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): v${{ env.VERSION }}"
          committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          add-paths: |
            Cargo.toml
            disks-dbus/Cargo.toml
            disks-ui/Cargo.toml
          branch: "chore/release-v${{ env.VERSION }}"
          delete-branch: true
          base: main
          title: "chore(release): v${{ env.VERSION }}"
          body: |
            Automated version bump to v${{ env.VERSION }}.

            This PR was created because `main` is protected/locked.
