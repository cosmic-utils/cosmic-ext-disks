# Code Quality Audit — storage-ui (cosmic-ext-disks)

**Timestamp:** 2026-02-06T17:26:25Z  
**Commit:** `04ee522b4f8a63aebfbc9d23be7dd2b77fbc3d16`  
**Branch:** `feature/ui-refactor`  
**Repository:** cosmic-utils/cosmic-ext-disks  
**Scope:** Code quality audit focused on `storage-ui/` module (UI crate only)  
**Lines of Code:** ~8,742 lines of Rust in storage-ui/src

---

## Executive Summary

**Top Issues by Priority:**

1. **Excessive `.clone()` abuse** — pervasive throughout codebase (50+ instances), causing unnecessary memory allocations and performance degradation
2. **Inconsistent error handling patterns** — mix of panics, silent ignores, and proper error surfacing; no unified error handling strategy
3. **Over-reliance on `#[allow(dead_code)]`** — 7+ instances masking code that should be removed or properly integrated
4. **Dialog state management complexity** — 17 distinct dialog structs with duplicated state management patterns
5. **Large view modules** — `app/view.rs` at 809 lines; difficult to reason about and maintain
6. **Duplication in mount/unmount operations** — repetitive error handling and Task creation patterns
7. **Nested conditionals and deeply nested match statements** — reducing readability significantly
8. **Unneeded comments and placeholder TODOs** — several non-actionable comments and one stale TODO

**Overall Assessment:** The codebase has acceptable functionality but suffers from technical debt accumulated during rapid feature development. The refactor branch shows improvement in structure but still carries forward several anti-patterns that should be addressed before merging.

---

## Surface Map

### Entrypoints
- [storage-ui/src/main.rs](../storage-ui/src/main.rs) — application bootstrap
- [storage-ui/src/app.rs](../storage-ui/src/app.rs) — public API re-exports

### Core State
- [storage-ui/src/ui/app/state.rs](../storage-ui/src/ui/app/state.rs) — `AppModel` (COSMIC application state)
- [storage-ui/src/ui/volumes/state.rs](../storage-ui/src/ui/volumes/state.rs) — `VolumesControl` and `Segment` types
- [storage-ui/src/ui/dialogs/state.rs](../storage-ui/src/ui/dialogs/state.rs) — 17 dialog state structs
- [storage-ui/src/ui/sidebar/state.rs](../storage-ui/src/ui/sidebar/state.rs) — sidebar tree state

### Update Logic (Message Handlers)
- [storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) (306 lines) — top-level message dispatcher
- [storage-ui/src/ui/volumes/update/*.rs](../storage-ui/src/ui/volumes/update/) — 7 modules handling volume operations
  - partition.rs (353 lines), encryption.rs (498 lines), mount_options.rs (387 lines)

### Views
- [storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs) (809 lines) — main view builder, dialog dispatcher
- [storage-ui/src/ui/volumes/view.rs](../storage-ui/src/ui/volumes/view.rs) (349 lines) — segment visualization and volume rows
- [storage-ui/src/ui/sidebar/view.rs](../storage-ui/src/ui/sidebar/view.rs) (465 lines) — sidebar tree rendering
- [storage-ui/src/ui/dialogs/view/*.rs](../storage-ui/src/ui/dialogs/view/) — dialog UI builders

### Utilities
- [storage-ui/src/utils/segments.rs](../storage-ui/src/utils/segments.rs) (453 lines) — disk segmentation logic
- [storage-ui/src/ui/volumes/helpers.rs](../storage-ui/src/ui/volumes/helpers.rs) — volume tree traversal helpers
- [storage-ui/src/utils/ui.rs](../storage-ui/src/utils/ui.rs) (210 lines) — UI helper widgets

---

## Findings (Prioritised Backlog)

### GAP-001: Excessive `.clone()` Abuse
**Type:** Performance / Code Smell  
**Severity:** High  
**Impact:** Unnecessary heap allocations, degraded performance, verbose code

**Evidence:**
- 50+ instances found via `grep '\.clone\(\)'` across storage-ui/src
- Particularly prevalent in:
  - [storage-ui/src/ui/app/update/drive.rs](../storage-ui/src/ui/app/update/drive.rs) L29-32, L46, L73-74, L109-110, etc.
  - [storage-ui/src/ui/app/update/smart.rs](../storage-ui/src/ui/app/update/smart.rs) L9, L33, L35, L37, L47, etc.
  - [storage-ui/src/ui/sidebar/view.rs](../storage-ui/src/ui/sidebar/view.rs) L178, L189, L220, L231, L266, etc.
  - [storage-ui/src/ui/volumes/update/mount.rs](../storage-ui/src/ui/volumes/update/mount.rs) L11, L41
  - [storage-ui/src/ui/app/update/nav.rs](../storage-ui/src/ui/app/update/nav.rs) L15, L45, L63, L78, L83-84, L89, L95-96, etc.

**Examples:**

```rust
// storage-ui/src/ui/app/update/drive.rs L29-32
let drive = state.drive.clone();
let selected = drive.block_path.clone();
let drive_path = drive.path.clone();
let device = drive.block_path.clone();
```

4 clones in a row when references would suffice. `selected` and `device` are identical.

```rust
// storage-ui/src/ui/volumes/update/mount.rs L11
let segment = control.segments.get(control.selected_segment).cloned();
if let Some(s) = segment.clone() {
    match s.volume {
        // ...
```

Double-clone: `.cloned()` already creates an owned value, then `segment.clone()` clones it again.

**Root Cause:** Pattern of "clone everything to make the borrow checker happy" rather than thinking about ownership/lifetimes.

**Suggested Fix:**
1. Audit each `.clone()` call to determine if it's truly necessary
2. Use references (`&`) in closures/Tasks wherever possible
3. Clone only immediately before moving into async contexts
4. For owned strings being passed to Tasks, extract once and reuse
5. Consider `Arc<T>` for shared read-only data (e.g., `DriveModel`)

**Acceptance Criteria:**
- [ ] Reduce `.clone()` usage by >60% (target: ~20 remaining in hot paths)
- [ ] All remaining clones have justifying comments if non-obvious
- [ ] No double-clone patterns (`.cloned()` + `.clone()`) remain
- [ ] Benchmark impact on drive list refresh (target: 15%+ improvement)

---

### GAP-002: Inconsistent Error Handling Patterns
**Type:** Reliability / Code Smell  
**Severity:** High  
**Impact:** Poor error visibility, inconsistent UX, silent failures

**Evidence:**

[storage-ui/src/ui/volumes/update/mount.rs](../storage-ui/src/ui/volumes/update/mount.rs) L18-30:
```rust
|result| match result {
    Ok(drives) => Message::UpdateNav(drives, None).into(),
    Err(e) => {
        tracing::error!(?e, "mount failed");
        Message::None.into()  // Silent failure — no dialog shown
    }
}
```

vs. [storage-ui/src/ui/volumes/update/partition.rs](../storage-ui/src/ui/volumes/update/partition.rs) L70-80:
```rust
|result| match result {
    Ok(drives) => Message::UpdateNav(drives, None).into(),
    Err(e) => {
        tracing::error!(?e, "delete failed");
        Message::Dialog(Box::new(ShowDialog::Info {
            title: fl!("delete-failed"),
            body: format!("{e:#}"),
        })).into()  // Dialog shown
    }
}
```

vs. [storage-ui/src/ui/volumes/update/partition.rs](../storage-ui/src/ui/volumes/update/partition.rs) L300-305:
```rust
|result| match result {
    Ok(drives) => Message::UpdateNav(drives, None).into(),
    Err(e) => {
        let ctx = UiErrorContext::new("edit_partition");
        log_error_and_show_dialog(fl!("edit-partition").to_string(), e, ctx).into()
    }
}
```

Three different error handling patterns:
1. Log only (silent to user)
2. Log + generic dialog
3. Log + contextual dialog via helper

**Additional Evidence:**
- [storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) L56: `tracing::warn!("received volumes message with no active VolumesControl");` — warning but no user feedback
- [storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) L67-70: early return with `Task::none()` on error — silent failure
- [storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs) L55: `match open::that_detached(&url) { Ok(()) => {} Err(err) => { tracing::warn!(...) } }` — log but no dialog

**Root Cause:** No unified error handling strategy. Ad-hoc decisions on whether to surface errors to users.

**Suggested Fix:**
1. Define error handling policy:
   - **User-initiated actions** (mount, delete, format, etc.) → always show dialog on error
   - **Background refreshes** → log only unless critical
   - **Invalid state transitions** → log warning + optionally show toast
2. Create standard error handler functions by category:
   - `handle_operation_error(title, err, ctx) -> Message` (for user ops)
   - `handle_background_error(operation, err)` (log only)
3. Migrate all mount/unmount/format/delete operations to use standard handlers
4. Add integration test that validates error dialogs appear for common failures

**Acceptance Criteria:**
- [ ] All user-initiated partition operations show error dialogs consistently
- [ ] All mount/unmount errors surface to user (no silent failures)
- [ ] Background refresh errors logged but don't block UI
- [ ] Error handling policy documented in `.copi/repo-rules.md`

---

### GAP-003: Over-Reliance on `#[allow(dead_code)]`
**Type:** Code Smell / Technical Debt  
**Severity:** Medium  
**Impact:** Masking unused code, obscuring API surface, potential confusion

**Evidence:**
```rust
// storage-ui/src/ui/volumes/state.rs L13
pub struct VolumesControl {
    // ...
    #[allow(dead_code)]
    pub model: DriveModel,
}
```

`DriveModel` is marked dead_code despite being used in helpers and update logic.

```rust
// storage-ui/src/ui/volumes/state.rs L18
#[derive(Clone, Debug)]
#[allow(dead_code)]
pub struct Segment { /* ... */ }
```

Entire struct marked dead_code when it's the core data type for volume visualization.

```rust
// storage-ui/src/ui/volumes/state.rs L82
#[allow(dead_code)]
pub fn get_create_info(&self) -> CreatePartitionInfo { /* ... */ }
```

Method appears unused but not clear why it exists.

```rust
// storage-ui/src/ui/app/message.rs L14
#[allow(dead_code)] // OpenPath temporarily unused
pub enum Message {
    OpenPath(String),
    // ...
}
```

`OpenPath` marked temporarily unused but is actually used in [storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) L37 and [storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs) L364.

```rust
// storage-ui/src/ui/dialogs/state.rs L4
#[allow(dead_code)]
pub enum ShowDialog { /* ... */ }
```

Enum is actively used throughout; attribute is incorrect.

```rust
// storage-ui/src/ui/volumes/view.rs L224
#[allow(dead_code)]
fn tooltip_icon_button(/* ... */) { /* ... */ }
```

Function truly appears unused; should be removed if not needed.

```rust
// storage-ui/src/ui/dialogs/message.rs L81
#[allow(dead_code)]
Continue,
```

`CreateMessage::Continue` variant marked dead but unclear if this is temporary or permanent.

**Root Cause:** Liberal use of `#[allow(dead_code)]` as a quick fix during refactoring rather than resolving underlying issues.

**Suggested Fix:**
1. Remove all `#[allow(dead_code)]` attributes
2. Run `cargo build` and address each warning:
   - If truly unused: delete the code
   - If used: investigate why compiler thinks it's dead (often visibility issue)
   - If planned future use: add a comment explaining and create a tracking issue
3. For `VolumesControl.model`, make field visibility clearer (likely should be `pub(crate)`)
4. For `OpenPath`, remove the incorrect comment
5. For `tooltip_icon_button`, either use it or remove it

**Acceptance Criteria:**
- [ ] Zero `#[allow(dead_code)]` attributes in storage-ui
- [ ] `cargo clippy` passes with no dead code warnings
- [ ] Any future-use code has tracking issues referenced in comments

---

### GAP-004: Dialog State Management Complexity
**Type:** Code Structure / Maintainability  
**Severity:** Medium  
**Impact:** Duplicated patterns, difficult to extend, high cognitive load

**Evidence:**

[storage-ui/src/ui/dialogs/state.rs](../storage-ui/src/ui/dialogs/state.rs) defines 17 separate dialog structs:

```rust
pub enum ShowDialog {
    DeletePartition(DeletePartitionDialog),
    AddPartition(CreatePartitionDialog),
    FormatPartition(FormatPartitionDialog),
    EditPartition(EditPartitionDialog),
    ResizePartition(ResizePartitionDialog),
    EditFilesystemLabel(EditFilesystemLabelDialog),
    EditMountOptions(EditMountOptionsDialog),
    ConfirmAction(ConfirmActionDialog),
    TakeOwnership(TakeOwnershipDialog),
    ChangePassphrase(ChangePassphraseDialog),
    EditEncryptionOptions(EditEncryptionOptionsDialog),
    UnlockEncrypted(UnlockEncryptedDialog),
    FormatDisk(FormatDiskDialog),
    SmartData(SmartDataDialog),
    NewDiskImage(Box<NewDiskImageDialog>),
    AttachDiskImage(Box<AttachDiskImageDialog>),
    ImageOperation(Box<ImageOperationDialog>),
    Info { title: String, body: String },
}
```

**Duplication Pattern:**

Nearly all dialog structs have:
- `running: bool` field for async operation state
- `error: Option<String>` field (8/17 dialogs)
- Repeated state extraction pattern in view.rs

Example duplication:
```rust
pub struct EditPartitionDialog {
    pub volume: VolumeModel,
    pub partition_types: Vec<PartitionTypeInfo>,
    pub selected_type_index: usize,
    pub name: String,
    pub legacy_bios_bootable: bool,
    pub system_partition: bool,
    pub hidden: bool,
    pub running: bool,  // ← duplicated
}

pub struct ResizePartitionDialog {
    pub volume: VolumeModel,
    pub min_size_bytes: u64,
    pub max_size_bytes: u64,
    pub new_size_bytes: u64,
    pub running: bool,  // ← duplicated
}

pub struct EditFilesystemLabelDialog {
    pub target: FilesystemTarget,
    pub label: String,
    pub running: bool,  // ← duplicated
}
```

**View Dispatch Boilerplate:**

[storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs) L29-119 contains 17 match arms that just delegate to dialog view functions:

```rust
match app.dialog {
    Some(ref d) => match d {
        ShowDialog::DeletePartition(state) => Some(dialogs::confirmation(/* ... */)),
        ShowDialog::AddPartition(state) => Some(dialogs::create_partition(state.clone())),
        ShowDialog::FormatPartition(state) => Some(dialogs::format_partition(state.clone())),
        // ... 14 more similar arms
    }
}
```

**Root Cause:** Each dialog feature added incrementally without refactoring common patterns.

**Suggested Fix:**
1. Extract common dialog state into a trait or base struct:
   ```rust
   pub struct AsyncDialogState<T> {
       pub data: T,
       pub running: bool,
       pub error: Option<String>,
   }
   ```
2. Consolidate simple confirmation dialogs into a generic `ConfirmAction` type (already exists but underused)
3. Consider a dialog builder pattern to reduce view.rs boilerplate
4. Move dialog view rendering into the dialog state modules (co-locate view with state)

**Acceptance Criteria:**
- [ ] `running` field appears in ≤3 places (base struct + variants that need custom state)
- [ ] `error` field consolidated similarly
- [ ] View dispatch reduced to <50 lines (from current 90)
- [ ] New dialogs can be added with <20 lines of boilerplate

---

### GAP-005: Large View Module — `app/view.rs` at 809 Lines
**Type:** Maintainability / Code Structure  
**Severity:** Medium  
**Impact:** Difficult to navigate, high merge conflict risk, cognitive overload

**Evidence:**
[storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs) contains:
- Dialog dispatch (90 lines)
- Nav bar override (20 lines)
- Main view builder (200 lines)
- Volume detail view builder (400+ lines with nested helpers)

Specific issues:
- L176-400: `view()` function is 224 lines
- L402-809: Multiple helper functions (some 100+ lines)
- Deep nesting: L216-240 has 5 levels of indentation
- Mixed concerns: UI layout + business logic (usage aggregation)

**Suggested Fix:**
1. Split into submodules:
   - `app/view/mod.rs` — main view function + coordination
   - `app/view/dialog.rs` — dialog dispatch
   - `app/view/volume_detail.rs` — volume detail panel
   - `app/view/empty_states.rs` — "no disk selected" etc.
2. Move usage aggregation logic to a helper in `volumes/helpers.rs`
3. Extract layout constants to module-level consts
4. Consider a view-builder pattern to reduce nesting

**Acceptance Criteria:**
- [ ] No single file >400 lines in `ui/app/view/`
- [ ] Maximum function length: 100 lines (current max: 224)
- [ ] Maximum nesting depth: 4 levels (current: 5+)
- [ ] Related functions grouped in submodules

---

### GAP-006: Duplication in Mount/Unmount Operations
**Type:** Code Smell / DRY Violation  
**Severity:** Low  
**Impact:** Maintenance burden, inconsistency risk

**Evidence:**

[storage-ui/src/ui/volumes/update/mount.rs](../storage-ui/src/ui/volumes/update/mount.rs) contains 4 nearly identical functions:

```rust
pub(super) fn mount(control: &mut VolumesControl) -> Task<...> {
    let segment = control.segments.get(control.selected_segment).cloned();
    if let Some(s) = segment.clone() {  // ← double clone
        match s.volume {
            Some(p) => {
                return Task::perform(
                    async move {
                        match p.mount().await {
                            Ok(_) => match DriveModel::get_drives().await {
                                Ok(drives) => Ok(drives),
                                Err(e) => Err(e),
                            },
                            Err(e) => Err(e),
                        }
                    },
                    |result| match result {
                        Ok(drives) => Message::UpdateNav(drives, None).into(),
                        Err(e) => {
                            tracing::error!(?e, "mount failed");
                            Message::None.into()
                        }
                    },
                );
            }
            None => return Task::none(),
        }
    }
    Task::none()
}

pub(super) fn unmount(control: &mut VolumesControl) -> Task<...> {
    let segment = control.segments.get(control.selected_segment).cloned();
    if let Some(s) = segment.clone() {  // ← double clone
        match s.volume {
            Some(p) => {
                return Task::perform(
                    async move {
                        match p.unmount().await {  // ← only difference
                            Ok(_) => match DriveModel::get_drives().await {
                                Ok(drives) => Ok(drives),
                                Err(e) => Err(e),
                            },
                            Err(e) => Err(e),
                        }
                    },
                    |result| match result {
                        Ok(drives) => Message::UpdateNav(drives, None).into(),
                        Err(e) => {
                            tracing::error!(%e, "unmount failed");  // ← minor formatting diff
                            Message::None.into()
                        }
                    },
                );
            }
            None => return Task::none(),
        }
    }
    Task::none()
}

// child_mount and child_unmount follow same pattern
```

Only differences:
1. Method called (`.mount()` vs `.unmount()`)
2. Log message
3. `segment` vs `object_path` source

**Suggested Fix:**
1. Create generic helper:
   ```rust
   fn perform_volume_operation<F, Fut>(
       volume: VolumeModel,
       operation: F,
       operation_name: &'static str,
   ) -> Task<...>
   where
       F: FnOnce(VolumeModel) -> Fut + Send + 'static,
       Fut: Future<Output = anyhow::Result<()>> + Send,
   {
       Task::perform(
           async move {
               operation(volume).await?;
               DriveModel::get_drives().await
           },
           move |result| match result {
               Ok(drives) => Message::UpdateNav(drives, None).into(),
               Err(e) => {
                   tracing::error!(?e, "{operation_name} failed");
                   Message::None.into()
               }
           },
       )
   }
   ```
2. Reduce functions to:
   ```rust
   pub(super) fn mount(control: &mut VolumesControl) -> Task<...> {
       let Some(volume) = control.segments
           .get(control.selected_segment)
           .and_then(|s| s.volume.as_ref())
           .cloned() else {
           return Task::none();
       };
       perform_volume_operation(volume, |v| v.mount(), "mount")
   }
   ```

**Acceptance Criteria:**
- [ ] Reduce mount.rs from 118 lines to <40 lines
- [ ] All 4 functions share single async/error handling path
- [ ] No functional regression in mount/unmount behavior

---

### GAP-007: Nested Conditionals and Deep Match Statements
**Type:** Code Smell / Readability  
**Severity:** Low  
**Impact:** Reduced readability, harder to reason about control flow

**Evidence:**

[storage-ui/src/ui/volumes/view.rs](../storage-ui/src/ui/volumes/view.rs) L68-170:
```rust
if let Some(v) = container_volume {
    // ...
    let top = cosmic::widget::button::custom(/* ... */).on_press(/* ... */).class(/* ... */);
    
    let bottom_content: Element<Message> = if v.locked {
        container(/* ... */).into()
    } else {
        let direct = &v.children;
        let mut col = iced_widget::column![].spacing(8);
        col = col.width(Length::Fill).height(Length::Fill);

        if direct.len() == 1 && !direct[0].children.is_empty() {
            col = col.push(volume_row_compact(/* ... */));
        } else {
            col = col.push(volume_row_compact(/* ... */));
        }

        col.into()
    };
    
    let bottom = container(bottom_content)/* ... */;
    
    return container(/* ... */).into();
}
```

5 levels of nesting with early returns scattered throughout.

[storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) L132-180: Complex nested volume selection logic with 6 levels of nesting.

**Suggested Fix:**
1. Use guard clauses and early returns to reduce nesting
2. Extract nested blocks into named functions
3. Consider pattern matching alternatives to nested if-let chains
4. Use `and_then` / `map` combinators where appropriate

**Example Refactor:**
```rust
// Before (nested)
if let Some(v) = container_volume {
    if v.locked {
        // locked path
    } else {
        // unlocked path
    }
}

// After (guard + extract)
let Some(v) = container_volume else {
    return build_standard_segment_button(segment, index);
};

if v.locked {
    return build_locked_container_button(segment, v, index);
}

build_unlocked_container_button(segment, v, index)
```

**Acceptance Criteria:**
- [ ] No function has >4 levels of indentation
- [ ] Nested conditional blocks >10 lines extracted to helper functions
- [ ] All if-let chains ≤2 levels deep

---

### GAP-008: Unnecessary Annotations and Placeholder TODOs
**Type:** Code Smell / Minor Technical Debt  
**Severity:** Low  
**Impact:** Code clarity, action item tracking

**Evidence:**

**Single Stale TODO:**
[storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) L75:
```rust
Message::DriveRemoved(_drive_model) => {
    // TODO: use DeviceManager.apply_change()

    return Task::perform(/* ... */);
}
```

This TODO references a non-existent `DeviceManager` API. Likely outdated from an earlier design.

**Unneeded Comment:**
[storage-ui/src/ui/app/update/image/ops.rs](../storage-ui/src/ui/app/update/image/ops.rs) L77:
```rust
// Preflight: attempt to unmount all mounted partitions.
```

The code immediately following makes this obvious; comment adds no value.

**Unhelpful Comment:**
[storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs) L135:
```rust
// XXX both must be shrink to avoid flex layout from ignoring it
nav = nav.max_width(280);
```

"XXX" suggests a hack, but no explanation of *why* this is needed or what the proper fix would be.

**Validation TODO:**
[storage-ui/src/utils/ui.rs](../storage-ui/src/utils/ui.rs) L30:
```rust
Err(_) => (text_edit)(value), //TODO: Validation
```

Unclear what validation is needed or when it will be added.

**Suggested Fix:**
1. For `DeviceManager.apply_change()`:
   - If this is a valid future enhancement, create a GitHub issue and update comment to reference it
   - If obsolete, remove the TODO
2. Remove self-documenting comment at image/ops.rs L77
3. For "XXX" comments, either:
   - Document the underlying layout issue properly, or
   - Confirm it's working as intended and remove "XXX"
4. For validation TODO: either add validation now or remove the comment

**Acceptance Criteria:**
- [ ] All TODOs have associated GitHub issues or are removed
- [ ] No "XXX" / "HACK" comments without explanation
- [ ] Comments add non-obvious information (remove self-documenting ones)

---

### GAP-009: Segment Width Calculation Not Validated
**Type:** Engineering Hole / Potential Bug  
**Severity:** Low  
**Impact:** Visual glitches if segment size calculation fails

**Evidence:**

[storage-ui/src/ui/volumes/state.rs](../storage-ui/src/ui/volumes/state.rs) L195-211:
```rust
let mut segments: Vec<Segment> = Vec::new();
for seg in computation.segments {
    match seg.kind {
        DiskSegmentKind::FreeSpace => {
            segments.push(Segment::free_space(/*...*/));
        }
        DiskSegmentKind::Reserved => {
            segments.push(Segment::reserved(/*...*/));
        }
        DiskSegmentKind::Partition => {
            let Some(partition_id) = seg.partition_id else {
                continue;  // ← silently skips if partition_id missing
            };
            // ...
        }
    }
}
```

Then in view rendering:
[storage-ui/src/ui/volumes/view.rs](../storage-ui/src/ui/volumes/view.rs) L74-80:
```rust
.width(Length::FillPortion(segment.width))
```

But `segment.width` is initialized to `0` and never set in state.rs. The width is only calculated in a separate location.

**Suggested Fix:**
1. Validate that `segment.width` is >0 before rendering
2. Consider setting width during segment creation rather than as a separate pass
3. Add debug assertion or warning if width is 0

**Acceptance Criteria:**
- [ ] No segments with width=0 reach rendering
- [ ] Segment creation validates all required fields are set
- [ ] Add test for edge case: single partition filling entire disk

---

### GAP-010: Inconsistent String Cloning in View Builders
**Type:** Code Smell / Performance  
**Severity:** Low  
**Impact:** Minor inefficiency

**Evidence:**

[storage-ui/src/ui/volumes/disk_header.rs](../storage-ui/src/ui/volumes/disk_header.rs) L21-31:
```rust
let table_type = match drive.partition_table_type.as_ref() {
    Some(t) => t.clone().to_uppercase(),  // ← clones String
    None => "".to_string(),
};

// ...

let model = if drive.model.is_empty() {
    drive.model.clone()  // ← clones empty string
} else {
    drive.vendor.clone()  // ← clones even if only reading
};
```

These strings are immediately used for display and never modified. Can use `&str` or `Cow<str>`.

**Suggested Fix:**
Use references or `Cow` where strings are only read:
```rust
let table_type = drive.partition_table_type
    .as_deref()
    .unwrap_or("")
    .to_uppercase();

let model = if drive.model.is_empty() {
    &drive.vendor
} else {
    &drive.model
};
```

**Acceptance Criteria:**
- [ ] View builders clone strings only when necessary (passed to async Tasks)
- [ ] Use `&str` or `Cow<str>` for display-only strings

---

## Quick Wins

These can be addressed with minimal effort:

1. **Remove unused `tooltip_icon_button` function** ([storage-ui/src/ui/volumes/view.rs](../storage-ui/src/ui/volumes/view.rs) L224-241) — 18 lines saved
2. **Fix incorrect `#[allow(dead_code)]` on `Message::OpenPath`** — remove annotation + comment
3. **Remove redundant `.clone()` in mount.rs double-clone pattern** — 4 instances
4. **Extract `"working"` string to fluent localization** — currently hardcoded in multiple dialogs
5. **Consolidate duplicate `Message::None` usage** — used inconsistently; consider `Message::Noop` or removing entirely

---

## Open Questions

1. **Is `DeviceManager.apply_change()` still a planned feature?** ([storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs) L75) — no evidence in codebase
2. **Why is `segment.width` set to 0 at creation?** Appears to be set elsewhere but could cause rendering issues
3. **Should mount/unmount errors be silent or show dialogs?** — inconsistent currently
4. **Is the sidebar refactor complete?** — uses both nav_bar and custom tree; is nav_bar being phased out?
5. **Are the `Info` dialogs intended to be dismissible or require action?** — current implementation allows dismiss but some contexts may need acknowledgement

---

## Appendix

### Notable Searches

- `TODO|FIXME|HACK|XXX`: 13 matches (1 actionable TODO, 1 XXX layout hack, rest are false positives like "temp_c")
- `#[allow(dead_code)]`: 7 instances (5 incorrect, 1 questionable, 1 valid)
- `\.clone\(\)`: 50+ instances (majority unnecessary)
- `.as_ref().map(|`: 20+ instances (good use of Option combinators)

### Files Reviewed (Partial List)

Core state and update modules:
- [storage-ui/src/ui/app/state.rs](../storage-ui/src/ui/app/state.rs)
- [storage-ui/src/ui/app/update/mod.rs](../storage-ui/src/ui/app/update/mod.rs)
- [storage-ui/src/ui/app/update/drive.rs](../storage-ui/src/ui/app/update/drive.rs)
- [storage-ui/src/ui/app/update/nav.rs](../storage-ui/src/ui/app/update/nav.rs)
- [storage-ui/src/ui/app/update/smart.rs](../storage-ui/src/ui/app/update/smart.rs)
- [storage-ui/src/ui/volumes/state.rs](../storage-ui/src/ui/volumes/state.rs)
- [storage-ui/src/ui/volumes/update/mount.rs](../storage-ui/src/ui/volumes/update/mount.rs)
- [storage-ui/src/ui/volumes/update/partition.rs](../storage-ui/src/ui/volumes/update/partition.rs)
- [storage-ui/src/ui/dialogs/state.rs](../storage-ui/src/ui/dialogs/state.rs)
- [storage-ui/src/ui/sidebar/state.rs](../storage-ui/src/ui/sidebar/state.rs)

View and rendering:
- [storage-ui/src/ui/app/view.rs](../storage-ui/src/ui/app/view.rs)
- [storage-ui/src/ui/volumes/view.rs](../storage-ui/src/ui/volumes/view.rs)
- [storage-ui/src/ui/volumes/disk_header.rs](../storage-ui/src/ui/volumes/disk_header.rs)
- [storage-ui/src/ui/sidebar/view.rs](../storage-ui/src/ui/sidebar/view.rs)
- [storage-ui/src/ui/dialogs/view/partition.rs](../storage-ui/src/ui/dialogs/view/partition.rs)
- [storage-ui/src/ui/dialogs/view/common.rs](../storage-ui/src/ui/dialogs/view/common.rs)

Utilities:
- [storage-ui/src/utils/segments.rs](../storage-ui/src/utils/segments.rs)
- [storage-ui/src/ui/volumes/helpers.rs](../storage-ui/src/ui/volumes/helpers.rs)
- [storage-ui/src/utils/ui.rs](../storage-ui/src/utils/ui.rs)

### Code Quality Metrics

| Metric | Current | Target |
|--------|---------|--------|
| Lines of code | 8,742 | — |
| Largest file | 809 lines (app/view.rs) | <400 |
| `.clone()` usage | 50+ | <20 |
| `#[allow(dead_code)]` | 7 | 0 |
| Max nesting depth | 5-6 levels | 4 |
| Dialog state structs | 17 | ~10 (via consolidation) |
| TODOs without issues | 1 | 0 |

---

**End of Audit**
