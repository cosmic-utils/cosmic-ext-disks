```markdown
# Repo Audit — cosmic-ext-disks (Delta)

Timestamp (UTC): 2026-01-24T18-03-04Z  
Repo: /home/stoorps/repos/cosmic-ext-disks  
Branch: fix/gpt-reserved-offsets-udisks  
Commit: ef81342568c4bb85c9a20b4b7b8c2ae7fd2c2f5e

Audit scope:
- Delta audit derived from `.copi/audits/2026-01-24T00-37-04Z.md`.
- Per `.copi/spec-index.md`, removed findings marked **Implemented** while preserving original GAP numbering.
- Re-checked evidence anchors for remaining findings against current branch.

---

## Executive Summary

- **MBR/DOS partition creation likely broken** due to table type mismatch (`"msdos"` vs `"dos"`), and an always-failing compatibility check.
- **Mount state detection depends on parsing `df` output**, then using “usage exists” as the mount indicator; this can diverge from UDisks2’s true mount state.
- **Several partition operations are stubs** (return `Ok(())` but do nothing), which risks misleading UX once wired.
- **Tests exist but coverage is narrow**: there are unit tests for GPT/segment logic, but destructive operations (create/delete/format/mount flows) have no integration coverage.
- **Release pipeline publishes with `--allow-dirty --no-verify`**, reducing reproducibility/verification of published artifacts.
- **A template SPDX header placeholder is shipped** in a source file.

---

## Surface Map

### Entrypoints
- UI app entrypoint: [disks-ui/src/main.rs](../../disks-ui/src/main.rs)
- COSMIC application model: [disks-ui/src/app.rs](../../disks-ui/src/app.rs)

### Public/interactive UI surfaces
- Main “Volumes” view and actions: [disks-ui/src/views/volumes.rs](../../disks-ui/src/views/volumes.rs)
- Create partition dialog: [disks-ui/src/views/dialogs.rs](../../disks-ui/src/views/dialogs.rs)
- Menu actions (disk/image/view): [disks-ui/src/views/menu.rs](../../disks-ui/src/views/menu.rs)

### Data & system interfaces
- Drive enumeration + create partition: [disks-dbus/src/disks/drive.rs](../../disks-dbus/src/disks/drive.rs)
- Partition operations (mount/unmount/delete): [disks-dbus/src/disks/partition.rs](../../disks-dbus/src/disks/partition.rs)
- Filesystem usage via local `df`: [disks-dbus/src/usage.rs](../../disks-dbus/src/usage.rs)

### CI / release surface
- PR CI gates: [.github/workflows/ci.yml](../../.github/workflows/ci.yml)
- Publish on push to `main`: [.github/workflows/main.yml](../../.github/workflows/main.yml)

---

## Findings (Prioritised Backlog)

### GAP-007 — Mount state detection relies on parsing `df`
- **Type:** Correctness / Reliability
- **Severity:** Medium
- **Impact:** UI might show Mount vs Unmount incorrectly (or hide mount errors), leading to confusing behavior and potential failures.
- **Evidence (facts):**
  - Usage sourced from `df`: [disks-dbus/src/usage.rs#L16](../../disks-dbus/src/usage.rs#L16)
  - UI uses presence/absence of `usage` as mount indicator: [disks-ui/src/views/volumes.rs#L581-L592](../../disks-ui/src/views/volumes.rs#L581-L592)
- **Suggested Fix:** Use UDisks2 filesystem mount points / mount state rather than `df` parsing; keep `df` as optional UI enrichment.
- **Acceptance Criteria:** Mount/unmount buttons reflect UDisks2-reported state.

### GAP-009 — Many partition operations are stubbed (return Ok but do nothing)
- **Type:** Missing Feature
- **Severity:** Medium
- **Impact:** Future UI wiring could mislead users into thinking actions succeeded.
- **Evidence (facts):** multiple `//TODO: implement` methods returning `Ok(())` in [disks-dbus/src/disks/partition.rs#L176-L306](../../disks-dbus/src/disks/partition.rs#L176-L306)
- **Suggested Fix:** Either implement these operations, or return an explicit `Err(NotImplemented)` until they are ready.
- **Acceptance Criteria:** No silent success for unimplemented disk operations.

### GAP-010 — Test coverage is incomplete for destructive/system-integrated flows
- **Type:** Testing
- **Severity:** High
- **Impact:** Regression risk remains high for disk operations (create/delete/format/mount/unmount), because failures won’t be caught until manual testing.
- **Evidence (facts):**
  - Unit tests exist for GPT helpers: [disks-dbus/src/disks/gpt.rs#L195-L210](../../disks-dbus/src/disks/gpt.rs#L195-L210)
  - Unit tests exist for segment computation: [disks-ui/src/utils/segments.rs#L289-L375](../../disks-ui/src/utils/segments.rs#L289-L375)
  - No test harness visible for UDisks2 interactions (no obvious mock layer or integration tests for `DriveModel`/`PartitionModel` flows).
- **Suggested Fix:**
  - Keep unit tests, and add a thin abstraction for UDisks2 calls so it can be mocked.
  - Add integration-ish tests for UI state transitions (no panics) and for DBus layer behavior (mocked).
- **Acceptance Criteria:**
  - CI includes tests that exercise create/delete/format/mount logic at least at a mocked/contract level.
  - A failing UDisks2 call surfaces as an error (and the test asserts it).

### GAP-011 — Release pipeline publishes with `--allow-dirty --no-verify`
- **Type:** Reliability / Release Engineering
- **Severity:** Medium
- **Impact:** Published artifacts may be harder to reproduce; verification is bypassed.
- **Evidence (facts):** `cargo publish --allow-dirty --no-verify` in publish workflow: [.github/workflows/main.yml#L74-L88](../../.github/workflows/main.yml#L74-L88)
- **Suggested Fix:** Publish from a clean tree and avoid `--no-verify` unless there is a documented reason.
- **Acceptance Criteria:** Release artifacts are reproducible and verifiable from a tagged commit.

### GAP-012 — SPDX header placeholder in i18n module
- **Type:** DX / Compliance Hygiene
- **Severity:** Low
- **Impact:** Confusing licensing metadata; may cause tooling warnings.
- **Evidence (facts):** `// SPDX-License-Identifier: {{ license }}`: [disks-ui/src/i18n.rs#L1](../../disks-ui/src/i18n.rs#L1)
- **Suggested Fix:** Replace with the repo’s actual license identifier (likely MPL-2.0) or remove if not required.
- **Acceptance Criteria:** No template placeholders in shipped source files.

---

## Quick Wins

- Normalize `dos/msdos` table type handling in [disks-dbus/src/disks/drive.rs](../../disks-dbus/src/disks/drive.rs) and [disks-dbus/src/partition_type.rs](../../disks-dbus/src/partition_type.rs).
- Switch mount state detection to UDisks2 properties; treat `df` as best-effort UI enrichment.
- Make stubbed partition operations return `Err(NotImplemented)` until implemented.
- Tighten publish workflow to remove `--allow-dirty --no-verify` (or document why they’re needed).
- Replace the SPDX placeholder in [disks-ui/src/i18n.rs](../../disks-ui/src/i18n.rs).

---

## Open Questions

- What is the intended authorization model for destructive ops (Polkit prompts? extra confirmations? “safe mode”)?
- Is DOS/MBR support intended soon, or should UI hide/disable those options for now?
- Should mount/unmount state be driven purely by UDisks2 (and how should transient states be represented in UI)?

---

## Appendix

### Notable searches performed (delta verification)
- `dos|msdos` in DBus layer (partition create + type catalogs)
- `df` usage in disk usage module
- Stubbed disk ops returning `Ok(())`
- Workflow publish flags `--allow-dirty --no-verify`
- SPDX placeholder `{{ license }}`

### Files reviewed (delta)
- [disks-dbus/src/disks/drive.rs](../../disks-dbus/src/disks/drive.rs)
- [disks-dbus/src/partition_type.rs](../../disks-dbus/src/partition_type.rs)
- [disks-dbus/src/disks/partition.rs](../../disks-dbus/src/disks/partition.rs)
- [disks-dbus/src/usage.rs](../../disks-dbus/src/usage.rs)
- [disks-ui/src/views/volumes.rs](../../disks-ui/src/views/volumes.rs)
- [.github/workflows/main.yml](../../.github/workflows/main.yml)
- [disks-ui/src/i18n.rs](../../disks-ui/src/i18n.rs)

```
