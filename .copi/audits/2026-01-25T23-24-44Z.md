# Audit Report — cosmic-ext-disks

- **Timestamp (UTC):** 2026-01-25T23-24-44Z
- **Repo:** cosmic-utils/cosmic-ext-disks
- **Path:** /home/stoorps/repos/cosmic-ext-disks
- **Branch:** main
- **Commit:** 89fbf8d98d54f48d1a508b88ed26247cc28fca8b
- **Audit scope:** Abstractions, Naming, Hierarchy, Separation of concerns, file length/complexity (UI + DBus crates)

## Executive Summary

- The UI state machine is concentrated in two very large files ([storage-ui/src/app.rs](../storage-ui/src/app.rs) ~1780 LOC, [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs) ~2750 LOC), creating high coupling and making it hard to reason about correctness.
- Dialog state, dialog views, and domain operations are tightly interwoven across modules (e.g., [storage-ui/src/app.rs](../storage-ui/src/app.rs) ↔ [storage-ui/src/views/dialogs.rs](../storage-ui/src/views/dialogs.rs) ↔ [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs)), resulting in a “ball of mud” hierarchy.
- In `storage-dbus`, responsibilities are mixed inside large “model” modules (e.g., [storage-dbus/src/disks/drive.rs](../storage-dbus/src/disks/drive.rs) bundles enumeration, SMART, image/loop handling, format/remove/preflight).
- The partition type catalog is a giant in-code static table ([storage-dbus/src/partition_type.rs](../storage-dbus/src/partition_type.rs) ~2070 LOC), making it hard to localize, test, or evolve.
- Multiple duplications signal missing shared abstractions: byte-string decoding and mount-point decoding duplicated between `VolumeModel` and `VolumeNode`, and byte formatting duplicated between UI and DBus crates.
- Naming issues/typos (e.g., `PasswordProectedUpdate`, `selected_partitition_type`) have propagated across crates and UI wiring, increasing cognitive load and risk.

## Surface Map

### Entrypoints
- UI app entry: [storage-ui/src/main.rs](../storage-ui/src/main.rs)
- UI model/runtime integration: [storage-ui/src/app.rs](../storage-ui/src/app.rs)
- DBus abstraction crate public surface: [storage-dbus/src/lib.rs](../storage-dbus/src/lib.rs)

### Public interfaces / major modules
- UI views: [storage-ui/src/views](../storage-ui/src/views)
  - Primary interaction surface: [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs)
  - Dialog rendering: [storage-ui/src/views/dialogs.rs](../storage-ui/src/views/dialogs.rs)
- DBus/domain “models” and operations: [storage-dbus/src/disks](../storage-dbus/src/disks)
  - Drive discovery + actions: [storage-dbus/src/disks/drive.rs](../storage-dbus/src/disks/drive.rs)
  - Partition model + mount options: [storage-dbus/src/disks/partition.rs](../storage-dbus/src/disks/partition.rs)
  - Nested volume tree (LUKS/LVM): [storage-dbus/src/disks/volume.rs](../storage-dbus/src/disks/volume.rs)
  - Backend ops abstraction: [storage-dbus/src/disks/ops.rs](../storage-dbus/src/disks/ops.rs)
- Partition type catalog: [storage-dbus/src/partition_type.rs](../storage-dbus/src/partition_type.rs)

### Largest complexity hotspots (LOC)
(From `wc -l`)
- [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs): 2751
- [storage-dbus/src/partition_type.rs](../storage-dbus/src/partition_type.rs): 2072
- [storage-ui/src/app.rs](../storage-ui/src/app.rs): 1780
- [storage-dbus/src/disks/drive.rs](../storage-dbus/src/disks/drive.rs): 1150
- [storage-ui/src/views/dialogs.rs](../storage-ui/src/views/dialogs.rs): 978
- [storage-dbus/src/disks/partition.rs](../storage-dbus/src/disks/partition.rs): 988
- [storage-dbus/src/disks/ops.rs](../storage-dbus/src/disks/ops.rs): 677
- [storage-dbus/src/disks/volume.rs](../storage-dbus/src/disks/volume.rs): 672

## Findings (Prioritised Backlog)

### GAP-001 — UI “God file” app model mixes state, messages, view, update, and IO
- **Type:** Reliability / DX
- **Severity:** High
- **Impact:** Increased likelihood of regressions and UI panics; hard to add features safely; difficult onboarding.
- **Evidence:**
  - `Message` enum and many UI actions live in the same file as app lifecycle and rendering: [storage-ui/src/app.rs](../storage-ui/src/app.rs#L327-L430)
  - The `view()` builds domain-specific panels and performs deep state access (with `unwrap()`): [storage-ui/src/app.rs](../storage-ui/src/app.rs#L562-L640)
  - The `update()` contains business operations and re-fetches drives repeatedly: [storage-ui/src/app.rs](../storage-ui/src/app.rs#L802-L910)
- **Repro/Trace:** Add a new dialog or action; you’ll likely need to edit types + view + update + dialog rendering across multiple sections of this file.
- **Suggested fix:** Split into focused modules:
  - `app/state.rs` (AppModel + persistent state)
  - `app/message.rs` (Message enums + conversions)
  - `app/subscriptions.rs` (device stream + config watch)
  - `app/update.rs` (update handlers / command construction)
  - Keep `app.rs` as glue.
- **Acceptance criteria:**
  - `AppModel` file(s) reduced to < ~400 LOC each.
  - No `unwrap()` needed for `nav.active_data` / selected segment; errors routed to an Info dialog.
  - A new action can be added by touching at most 2 modules.

### GAP-002 — volumes view file combines UI rendering, domain logic, and dialog routing
- **Type:** Reliability / DX
- **Severity:** High
- **Impact:** The main user journey is difficult to maintain; state-machine complexity encourages “patch fixes”; behavior becomes implicit.
- **Evidence:**
  - Domain segmentation logic + UI filtering + logging embedded in the view module: [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs#L382-L520)
  - Massive dialog routing inside `VolumesControlMessage` handling (many “ignore” cases): [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs#L1688-L1905)
  - Unimplemented message variant used as a runtime log warning: [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs#L1746-L1748)
- **Repro/Trace:** Add one new partition workflow step (e.g., “choose filesystem label”) and the message handler grows further.
- **Suggested fix:** Split along responsibilities:
  - `views/volumes/view.rs` (pure widget rendering)
  - `views/volumes/state.rs` (`VolumesControl` state)
  - `views/volumes/update.rs` (message → state transitions)
  - `views/volumes/actions.rs` (async tasks calling `disks_dbus`)
  - Replace `eprintln!` with structured logging + user-visible error dialogs.
- **Acceptance criteria:**
  - `views/volumes.rs` becomes a small module or `mod.rs` that re-exports submodules.
  - Message handler no longer needs to check “which dialog is open” in dozens of branches.

### GAP-003 — Dialog hierarchy is inverted; dialog views depend on app internals + volumes messages
- **Type:** Architecture / DX
- **Severity:** High
- **Impact:** Tight coupling makes it hard to reuse dialogs, test them, or introduce new UI flows without cascading changes.
- **Evidence:**
  - Dialog views import dialog state from `crate::app` and message types from `views::volumes`: [storage-ui/src/views/dialogs.rs](../storage-ui/src/views/dialogs.rs#L1-L30)
  - Dialog state types are defined in the top-level app model file: [storage-ui/src/app.rs](../storage-ui/src/app.rs#L55-L220)
- **Inference:** The UI layer lacks a clear “ownership” boundary for dialog state vs dialog rendering vs domain actions.
- **Suggested fix:** Move dialog state + messages into the dialogs module (or a `dialogs/state.rs`) and have `AppModel` store `DialogState` as an opaque enum.
- **Acceptance criteria:**
  - `views/dialogs.rs` does not import `crate::views::volumes::*` message enums.
  - Dialog state types live under `views/dialogs/` (or `ui/dialogs/`).

### GAP-004 — DriveModel module mixes discovery, modeling, and multiple action domains
- **Type:** Architecture / DX
- **Severity:** High
- **Impact:** Difficult to evolve “Drive” capabilities (e.g., SMART vs imaging vs partitioning) without accidental coupling.
- **Evidence:**
  - Drive enumeration also builds nested volume trees (LUKS/LVM): [storage-dbus/src/disks/drive.rs](../storage-dbus/src/disks/drive.rs#L266-L360)
  - Same file contains SMART ATA selftest operations and partition creation, disk formatting, and preflight traversal: [storage-dbus/src/disks/drive.rs](../storage-dbus/src/disks/drive.rs#L980-L1105)
- **Suggested fix:** Split into:
  - `drive/discovery.rs` (enumeration)
  - `drive/actions.rs` (format/remove/eject)
  - `drive/smart.rs`
  - `drive/volume_tree.rs` (node building)
- **Acceptance criteria:**
  - Each submodule < ~400 LOC.
  - Drive discovery functions do not also implement SMART logic.

### GAP-005 — Partition type catalog is a giant in-code static array (hard to localize/maintain)
- **Type:** DX
- **Severity:** Medium
- **Impact:** Hard to review changes; hard to add i18n; rebuild required for data tweaks.
- **Evidence:**
  - `PARTITION_TYPES` is a 228-entry static array: [storage-dbus/src/partition_type.rs](../storage-dbus/src/partition_type.rs#L228-L280)
  - File is ~2072 LOC, dominated by data; has a TODO to wrap names with gettext: [storage-dbus/src/partition_type.rs](../storage-dbus/src/partition_type.rs#L54-L60)
- **Suggested fix:** Move catalog into a data file (TOML/JSON) loaded at compile-time via `include_str!` + parse (or a small codegen step in `build.rs`). Split GPT/DOS into separate modules or data files.
- **Acceptance criteria:**
  - Catalog data lives outside `.rs` source or is split into smaller modules.
  - Names are localized or prepared for localization without changing hundreds of lines.

### GAP-006 — Duplicated encoding/decoding helpers across VolumeModel and VolumeNode
- **Type:** Bug Risk / DX
- **Severity:** Medium
- **Impact:** Divergent behavior and subtle bugs (e.g., different decode semantics) as features expand.
- **Evidence:**
  - `VolumeModel` duplicates `encode_bytestring`, `decode_c_string_bytes`, `decode_mount_points`, etc.: [storage-dbus/src/disks/partition.rs](../storage-dbus/src/disks/partition.rs#L45-L114)
  - `VolumeNode` repeats the same patterns: [storage-dbus/src/disks/volume.rs](../storage-dbus/src/disks/volume.rs#L43-L112)
- **Suggested fix:** Introduce `udisks_string.rs` or `zvariant_helpers.rs` with shared decode/encode routines; reuse from both structs.
- **Acceptance criteria:**
  - Single source of truth for bytestring decoding.
  - Unit tests cover decode behavior for C-string `Vec<u8>` and empty/invalid cases.

### GAP-007 — Byte formatting utilities are duplicated across crates
- **Type:** Architecture / DX
- **Severity:** Medium
- **Impact:** Layering confusion; risk of inconsistent formatting (locale, rounding).
- **Evidence:**
  - DBus crate formatting: [storage-dbus/src/format.rs](../storage-dbus/src/format.rs)
  - UI crate formatting (very similar code, different style): [storage-ui/src/utils/format.rs](../storage-ui/src/utils/format.rs)
- **Suggested fix:** Use a single implementation (preferably `storage-dbus` re-exported for UI) or create a small `disks-common` crate for shared pure utilities.
- **Acceptance criteria:**
  - Only one `bytes_to_pretty/pretty_to_bytes` implementation.
  - UI imports it from one place.

### GAP-008 — Naming typos and inconsistent terms propagate through UI + DBus
- **Type:** DX
- **Severity:** Medium
- **Impact:** Cognitive load; makes APIs feel unstable; harder to search and refactor.
- **Evidence:**
  - Typo in message variant: `PasswordProectedUpdate`: [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs#L126-L140)
  - Typo in core data field `selected_partitition_type` used across UI and DBus: [storage-dbus/src/disks/create_partition_info.rs](../storage-dbus/src/disks/create_partition_info.rs#L1-L20)
  - Usage sites across files: [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs#L1739-L1745), [storage-dbus/src/disks/ops.rs](../storage-dbus/src/disks/ops.rs)
- **Suggested fix:** Plan a rename pass:
  - `PasswordProtectedUpdate`
  - `selected_partition_type_index` (or similar)
  - Provide a short deprecation window if these are public APIs (crate-level).
- **Acceptance criteria:**
  - No misspelled public fields/variants remain.
  - `rg "partitition|proected"` returns zero results.

### GAP-009 — Confusing domain model naming: VolumeModel vs PartitionModel alias vs VolumeNode
- **Type:** Architecture / DX
- **Severity:** Medium
- **Impact:** Confusing mental model; developers can’t tell when they’re working with a “partition”, “volume”, “node”, or “block”.
- **Evidence:**
  - `PartitionModel` is an alias to `VolumeModel`: [storage-dbus/src/disks/mod.rs](../storage-dbus/src/disks/mod.rs#L1-L20)
  - Tree representation uses `VolumeNode` with `VolumeKind`: [storage-dbus/src/disks/volume.rs](../storage-dbus/src/disks/volume.rs#L20-L42)
- **Suggested fix:** Pick a single vocabulary:
  - If “partition” is the core object: `Partition` (flat) + `VolumeNode` (tree)
  - Otherwise: `BlockVolume` (flat) + `VolumeTreeNode`.
  - Remove the alias to avoid ambiguity.
- **Acceptance criteria:**
  - Public exports reflect chosen vocabulary; alias removed.
  - UI code uses one consistent term.

### GAP-010 — State assumptions cause unwrap-based crashes in UI rendering
- **Type:** Reliability
- **Severity:** Medium
- **Impact:** Crash risk when nav state and segments are temporarily out of sync (device hotplug, refresh, error paths).
- **Evidence:**
  - `unwrap()` on active volumes control and selected segment: [storage-ui/src/app.rs](../storage-ui/src/app.rs#L573-L579)
  - `unwrap()` on active data in update path: [storage-ui/src/app.rs](../storage-ui/src/app.rs#L830-L833)
- **Suggested fix:** Convert to defensive rendering: show “loading” / “no selection” and keep invariants in one place (e.g., `VolumesControl::ensure_valid_selection`).
- **Acceptance criteria:**
  - No `unwrap()` in `view()` for nav/segment access.
  - Hotplug refresh never panics (manual test: attach/remove loop device while app open).

### GAP-011 — Logging/error reporting is scattered and not layered
- **Type:** DX
- **Severity:** Low
- **Impact:** Hard to debug issues; user-visible errors are inconsistent.
- **Evidence:**
  - `println!/eprintln!` used for operational errors and anomalies: [storage-ui/src/app.rs](../storage-ui/src/app.rs#L392-L410), [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs#L409-L458)
- **Suggested fix:** Adopt `tracing` consistently; translate important failures into UI Info dialog/toast; keep `eprintln!` for truly exceptional fallback.
- **Acceptance criteria:**
  - A consistent error surface exists for user operations.

## Quick Wins

- Rename the misspellings (`PasswordProectedUpdate`, `selected_partitition_type`) and update call sites (small but high-leverage for readability).
- Deduplicate byte formatting by using the DBus crate’s `bytes_to_pretty` in UI (or create a shared utility crate).
- Extract shared bytestring/mount-point decoding helpers into one module and reuse from both `VolumeModel` and `VolumeNode`.

## Open Questions

- What’s the intended long-term domain vocabulary: “partition” vs “volume” vs “filesystem” vs “block”? (This affects naming and module hierarchy.)
- Should the UI be allowed to call disk ops directly from view modules, or should actions be centralized in a command/service layer?
- Is `storage-dbus` meant to be a stable API consumed by other apps, or primarily internal to this UI?

## Appendix

### Notable searches / hotspots
- Large files by LOC: `find ... | wc -l | sort -n | tail`
- Unwrap/TODO hotspots: `rg -n "TODO|unwrap\(|not implemented"` (examples: `CreateMessage::Continue is not implemented` in volumes view)

### Files reviewed (sampling)
- [storage-ui/src/app.rs](../storage-ui/src/app.rs)
- [storage-ui/src/views/volumes.rs](../storage-ui/src/views/volumes.rs)
- [storage-ui/src/views/dialogs.rs](../storage-ui/src/views/dialogs.rs)
- [storage-ui/src/utils/segments.rs](../storage-ui/src/utils/segments.rs)
- [storage-dbus/src/disks/drive.rs](../storage-dbus/src/disks/drive.rs)
- [storage-dbus/src/disks/partition.rs](../storage-dbus/src/disks/partition.rs)
- [storage-dbus/src/disks/volume.rs](../storage-dbus/src/disks/volume.rs)
- [storage-dbus/src/partition_type.rs](../storage-dbus/src/partition_type.rs)
