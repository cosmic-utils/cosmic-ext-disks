# Repo Audit — cosmic-ext-disks

Timestamp (UTC): 2026-01-24T00-37-04Z  
Repo: /home/stoorps/repos/cosmic-ext-disks  
Branch: main  
Commit: fa413cf9fcd22c5e00d797246b4e23ebf30667ce

Audit scope:
- Scanned Rust workspace structure, UI surfaces, DBus/UDisks abstraction, CI workflows, and READMEs.
- Looked for missing functionality vs documented/visible UI, safety/security gaps, reliability/test gaps, and operational/delivery gaps.

---

## Executive Summary

- **Crash-on-click paths exist in the UI**: multiple menu actions and dialog actions are `todo!()` / `panic!()` and will hard-crash when used.
- **Partition creation UX has unsafe/unfinished edges**: “Cancel” in the create-partition dialog is wired to `todo!()` and will crash; dialog state handling can `panic!()`.
- **Partition size visualization is using hacks** (hidden trailing bytes, offset heuristics), indicating correctness gaps and potentially misleading UI.
- **MBR/DOS partition creation likely broken** due to table type string mismatch (`"msdos"` vs `"dos"`), aligning with README “GPT only”.
- **No automated tests** exist, despite destructive operations (delete/create/format). CI runs tests, but there are none.
- **Mount state detection depends on parsing `df` output**, which can diverge from UDisks2’s actual mount state.
- **Device change detection is polling-based (1s)** instead of DBus signals; may be noisy and less reliable.
- **Observability & UX error reporting are minimal** (mostly `println!/eprintln!`; tracing init commented out).

---

## Surface Map

### Entrypoints
- UI app entrypoint: [disks-ui/src/main.rs](../../disks-ui/src/main.rs)
- COSMIC application model: [disks-ui/src/app.rs](../../disks-ui/src/app.rs)

### Public/interactive UI surfaces
- Main “Volumes” view and actions: [disks-ui/src/views/volumes.rs](../../disks-ui/src/views/volumes.rs)
- Create partition dialog: [disks-ui/src/views/dialogs.rs](../../disks-ui/src/views/dialogs.rs)
- Menu actions (disk/image/view): [disks-ui/src/views/menu.rs](../../disks-ui/src/views/menu.rs)

### Data & system interfaces
- UDisks2 polling manager proxy: [disks-dbus/src/disks/manager.rs](../../disks-dbus/src/disks/manager.rs)
- Drive enumeration + create partition: [disks-dbus/src/disks/drive.rs](../../disks-dbus/src/disks/drive.rs)
- Partition operations (mount/unmount/delete): [disks-dbus/src/disks/partition.rs](../../disks-dbus/src/disks/partition.rs)
- Filesystem usage via local `df`: [disks-dbus/src/usage.rs](../../disks-dbus/src/usage.rs)

### CI / release surface
- PR CI gates: [.github/workflows/ci.yml](../../.github/workflows/ci.yml)
- Publish on push to `main`: [.github/workflows/main.yml](../../.github/workflows/main.yml)

---

## Findings (Prioritised Backlog)

### GAP-001 — Create-partition dialog “Cancel” crashes the app
- **Type:** Bug Risk / UX
- **Severity:** Critical
- **Impact:** A normal user action (“Cancel”) triggers a panic, causing app termination.
- **Evidence (facts):**
  - Cancel button emits `CreateMessage::Cancel`: [disks-ui/src/views/dialogs.rs#L107](../../disks-ui/src/views/dialogs.rs#L107)
  - Handler is `todo!()` for cancel: [disks-ui/src/views/volumes.rs#L386](../../disks-ui/src/views/volumes.rs#L386)
- **Repro/Trace:** Select free space → click “+” (add partition) → click “Cancel” → app panics.
- **Suggested Fix:** Implement `CreateMessage::Cancel` to close dialog safely (set `dialog=None`), and avoid panics for normal control flow.
- **Acceptance Criteria:**
  - Clicking Cancel closes the dialog and returns to the main view.
  - No `panic!()`/`todo!()` reachable from UI controls.

### GAP-002 — Create-partition dialog can panic on unexpected state
- **Type:** Reliability
- **Severity:** High
- **Impact:** If the dialog state is inconsistent (or a message arrives late), the app panics.
- **Evidence (facts):** `None => panic!("invalid state")` in dialog update: [disks-ui/src/views/volumes.rs#L363](../../disks-ui/src/views/volumes.rs#L363)
- **Repro/Trace:** Hard to reproduce intentionally; any mismatch between UI state and emitted messages could trigger this.
- **Suggested Fix:** Replace panic with a no-op + log, or reset dialog state; treat as recoverable.
- **Acceptance Criteria:** No panics in dialog state transitions; invalid states are safely handled.

### GAP-003 — Several menu actions are wired to `todo!()` (crash-on-click)
- **Type:** Missing Feature / Bug Risk
- **Severity:** Critical
- **Impact:** Clicking menu items (PowerOff/Format/Benchmark/etc.) will crash.
- **Evidence (facts):** Unimplemented actions in update handler: [disks-ui/src/app.rs#L532-L542](../../disks-ui/src/app.rs#L532-L542)
- **Repro/Trace:** Open menu → click “Format disk” (or other) → app panics.
- **Suggested Fix:** Either implement the actions or hide/disable them until implemented. Prefer feature-flagging/conditional menu items.
- **Acceptance Criteria:** Menu contains only implemented actions, or disabled items do not crash and show “Not implemented” UX.


### GAP-005 — MBR/DOS partition creation likely broken (table type mismatch)
- **Type:** Bug Risk / Missing Feature
- **Severity:** High
- **Impact:** On msdos/MBR disks, create partition likely fails with “Unsupported partition table type”. This matches README claim “GPT only currently”, but the UI exposes partition creation broadly.
- **Evidence (facts):**
  - Create-partition chooses DOS types only when table type is `"msdos"`: [disks-dbus/src/disks/drive.rs#L270-L276](../../disks-dbus/src/disks/drive.rs#L270-L276)
  - Partition types list uses `"dos"` as the table type: [disks-dbus/src/partition_type.rs#L67-L113](../../disks-dbus/src/partition_type.rs#L67-L113)
  - UI passes through `drive.partition_table_type` into create info: [disks-ui/src/views/volumes.rs#L93-L145](../../disks-ui/src/views/volumes.rs#L93-L145)
- **Inference:** UDisks2 commonly reports the DOS/MBR table as `"dos"`; if so, `"msdos"` will never match.
- **Suggested Fix:** Normalize table type strings (treat `dos` and `msdos` equivalently) and/or explicitly gate creation to GPT until DOS is supported.
- **Acceptance Criteria:**
  - On DOS/MBR disks, either partition creation is disabled with clear explanation, or it succeeds.

### GAP-006 — Disabled state in segment button styling can crash
- **Type:** Reliability / UI
- **Severity:** Medium
- **Impact:** If the button enters disabled state, style function hits `todo!()`.
- **Evidence (facts):** [disks-ui/src/views/volumes.rs#L536](../../disks-ui/src/views/volumes.rs#L536)
- **Suggested Fix:** Implement disabled styling or map to normal styling.
- **Acceptance Criteria:** No `todo!()` in style code paths.

### GAP-007 — Mount state detection relies on parsing `df`
- **Type:** Correctness / Reliability
- **Severity:** Medium
- **Impact:** UI might show Mount vs Unmount incorrectly, leading to confusing behavior and potential errors.
- **Evidence (facts):**
  - Usage sourced from `df`: [disks-dbus/src/usage.rs#L16](../../disks-dbus/src/usage.rs#L16)
  - UI uses presence/absence of usage as mount indicator: [disks-ui/src/views/volumes.rs#L470-L476](../../disks-ui/src/views/volumes.rs#L470-L476)
- **Suggested Fix:** Use UDisks2 filesystem mount points / mount state rather than `df` parsing; treat `df` as optional UI enrichment.
- **Acceptance Criteria:** Mount/unmount buttons reflect UDisks2-reported state.

### GAP-008 — Device change detection is polling-based (1s) instead of signal-based
- **Type:** Performance / Reliability
- **Severity:** Medium
- **Impact:** Extra system load; may miss fast transitions; updates can feel laggy.
- **Evidence (facts):** `device_event_stream(Duration::from_secs(1))` usage in UI: [disks-ui/src/app.rs#L351](../../disks-ui/src/app.rs#L351); polling loop in manager: [disks-dbus/src/disks/manager.rs](../../disks-dbus/src/disks/manager.rs)
- **Suggested Fix:** Subscribe to UDisks2 DBus signals for object add/remove (or object manager), fall back to polling if signals unavailable.
- **Acceptance Criteria:** Device insert/remove updates occur promptly without polling.

### GAP-009 — Many partition operations are stubbed (return Ok but do nothing)
- **Type:** Missing Feature
- **Severity:** Medium
- **Impact:** Future UI wiring could mislead users into thinking actions succeeded.
- **Evidence (facts):** stubs in [disks-dbus/src/disks/partition.rs#L175-L283](../../disks-dbus/src/disks/partition.rs#L175-L283)
- **Suggested Fix:** Either implement, or return `Err` with “Not implemented” until ready.
- **Acceptance Criteria:** No silent success for unimplemented disk operations.

### GAP-010 — No tests present
- **Type:** Testing
- **Severity:** High
- **Impact:** High regression risk for destructive operations; CI is green even if core behaviors break.
- **Evidence (facts):** No `#[test]` or `tests/` found in repo (code search).
- **Suggested Fix:** Add at least:
  - Unit tests for pure functions (formatting, segment computation),
  - Contract-like tests with mocked UDisks2 interfaces (where feasible),
  - Basic smoke test for UI state transitions without panics.
- **Acceptance Criteria:** CI runs a non-trivial test suite that fails when core regressions occur.

### GAP-011 — Release pipeline publishes with `--allow-dirty --no-verify`
- **Type:** Reliability / Release Engineering
- **Severity:** Medium
- **Impact:** Published artifacts may be harder to reproduce; verification is bypassed.
- **Evidence (facts):** `cargo publish --allow-dirty --no-verify` in publish workflow: [.github/workflows/main.yml#L91-L105](../../.github/workflows/main.yml#L91-L105)
- **Suggested Fix:** Prefer publishing from a clean tree or commit the version bump; avoid `--no-verify` unless there is a documented reason.
- **Acceptance Criteria:** Release artifacts are reproducible and verifiable from a tagged commit.

### GAP-012 — SPDX header placeholder in i18n module
- **Type:** DX / Compliance Hygiene
- **Severity:** Low
- **Impact:** Confusing licensing metadata; may cause tooling warnings.
- **Evidence (facts):** `// SPDX-License-Identifier: {{ license }}`: [disks-ui/src/i18n.rs#L1](../../disks-ui/src/i18n.rs#L1)
- **Suggested Fix:** Replace with the repo’s actual license identifier (likely MPL-2.0) or remove if not required.
- **Acceptance Criteria:** No template placeholders in shipped source files.

---

## Quick Wins

- Replace user-facing `todo!()`/`panic!()` paths with safe no-ops + user-visible error banners.
  - Key targets: [disks-ui/src/app.rs#L532-L542](../../disks-ui/src/app.rs#L532-L542), [disks-ui/src/views/volumes.rs#L363-L386](../../disks-ui/src/views/volumes.rs#L363-L386)
- Fix table-type normalization (`dos` vs `msdos`) or explicitly disable DOS partition creation with a clear message.
  - Key target: [disks-dbus/src/disks/drive.rs#L270-L286](../../disks-dbus/src/disks/drive.rs#L270-L286)
- Swap `df`-based mount detection for UDisks2 mount points.
  - Key target: [disks-dbus/src/usage.rs#L16](../../disks-dbus/src/usage.rs#L16)

---

## Open Questions

- What is the intended authorization model for destructive ops (Polkit prompts? extra confirmations? “safe mode”)?
- Should this app explicitly gate dangerous operations behind a “prototype” warning every time (beyond README)?
- Is DOS/MBR support intended soon, or should UI hide those options for now?

---

## Appendix

### Notable searches performed
- `TODO|FIXME|HACK|NOT IMPLEMENTED` across `**/*.rs`
- `todo!\(|panic!\(|unwrap\(|expect\(` across `**/*.rs`
- Looked for tests: `#[test]`, `mod tests`, `tests/` (none found)

### Files reviewed (high-signal)
- [README.md](../../README.md)
- [disks-ui/src/app.rs](../../disks-ui/src/app.rs)
- [disks-ui/src/views/volumes.rs](../../disks-ui/src/views/volumes.rs)
- [disks-ui/src/views/dialogs.rs](../../disks-ui/src/views/dialogs.rs)
- [disks-ui/src/views/menu.rs](../../disks-ui/src/views/menu.rs)
- [disks-dbus/src/disks/drive.rs](../../disks-dbus/src/disks/drive.rs)
- [disks-dbus/src/disks/partition.rs](../../disks-dbus/src/disks/partition.rs)
- [disks-dbus/src/disks/manager.rs](../../disks-dbus/src/disks/manager.rs)
- [disks-dbus/src/usage.rs](../../disks-dbus/src/usage.rs)
- [.github/workflows/ci.yml](../../.github/workflows/ci.yml)
- [.github/workflows/main.yml](../../.github/workflows/main.yml)
